	PUBLIC	TIMERF
DGROUP	GROUP	ASMEXT_DATA
ASMEXT_TEXT	SEGMENT	PARA	PUBLIC	'CODE'
	ASSUME	CS:ASMEXT_TEXT,DS:DGROUP,ES:NOTHING,SS:DGROUP
TIMERF	PROC	FAR
	PUSH	BP
	MOV	BP,SP
	MOV	CX,[BP+6]
	TEST	CX,CX
	JNZ	@F
	CALL	HOOK
@@:	CMP	CX,1
	JNE	@F
	CALL	UNH
@@:	CMP	CX,2
	JNE	@F
	CALL	READ
@@:	CMP	CX,20H
	JNE	@F
	CALL	START
@@:	POP	BP
	RET	2
TIMERF	ENDP
HOOK	PROC	NEAR
	XOR	AX,AX
	MOV	ES,AX
	CLI
	MOV	AX,ES:[20H]
	MOV	[SVADR],AX
	MOV	AX,ES:[22H]
	MOV	[SVADR+2],AX
	MOV	ES:[20H],OFFSET HANDLE
	MOV	ES:[22H],SEG HANDLE
	MOV	AL,00110100B
	OUT	43H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	XOR	AL,AL
	OUT	40H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	40H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	STI
	RET
HOOK	ENDP
UNH	PROC	NEAR
	XOR	AX,AX
	MOV	ES,AX
	CLI
	MOV	AX,[SVADR]
	MOV	ES:[20H],AX
	MOV	AX,[SVADR+2]
	MOV	ES:[22H],AX
	MOV	AL,00110110B
	OUT	43H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	XOR	AL,AL
	OUT	40H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	40H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	STI
	RET
UNH	ENDP
READ	PROC	NEAR
	PUSH	CX
	CALL	RDTIM
	SUB	AX,[INITIME]
	SBB	DX,[INITIME+2]
	POP	CX
	RET
READ	ENDP
START	PROC	NEAR
	PUSH	CX
	CALL	RDTIM
	MOV	[INITIME],AX
	MOV	[INITIME+2],DX
	POP	CX
	RET
START	ENDP
RDTIM	PROC	NEAR
	XOR	AL,AL
	CLI
	OUT	43H,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,40H
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	MOV	DL,AL
	IN	AL,40H
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	MOV	DH,AL
	MOV	AX,[COUNTER]
	STI
	DEC	DX
	TEST	DX,DX
	MOV	BX,[COUNTER]
	JNS	@F
	MOV	AX,BX
@@:	NOT	DX
	XCHG	AX,DX
	RET
RDTIM	ENDP
HANDLE	PROC	FAR
	STI
	PUSH	AX
	PUSH	DS
	MOV	AX,DGROUP
	MOV	DS,AX
	INC	[COUNTER]
	IN	AL,61H
	JMP	SHORT	$+2
	OR	AL,10000000B
	OUT	61H,AL
	JMP	SHORT	$+2
	POP	DS
	MOV	AL,20H
	CLI
	OUT	20H,AL
	POP	AX
	IRET
HANDLE	ENDP
ASMEXT_TEXT	ENDS
ASMEXT_DATA	SEGMENT	WORD	PUBLIC	'DATA'
INITIME	DW	?,?
SVADR	DW	?,?
COUNTER	DW	?
ASMEXT_DATA	ENDS
	END
