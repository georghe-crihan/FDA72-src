	OPTION	OFFSET:GROUP
	PUBLIC	ACPFUN,ACPONE,ACPRES
DGROUP	GROUP	ASMEXT_DATA
ASMEXT_TEXT	SEGMENT	PARA	PUBLIC	'CODE'
	ASSUME	CS:ASMEXT_TEXT,DS:DGROUP,ES:NOTHING,SS:DGROUP
ACPFUN	PROC	FAR
	PUSH	BP
	PUSH	SI
	PUSH	DI
	MOV	BP,SP
	MOV	CX,[BP+0EH]
	PUSH	BP
	XOR	BX,BX
	XOR	BP,BP
	MOV	SI,0FFFFH
	XOR	DI,DI
	XOR	DX,DX
GLOCYC:	PUSH	CX
	PUSH	DX
	MOV	DX,306H
	XOR	AL,AL
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	XOR	CX,CX
@@:	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
;	MOV	AX,3804H	; TEMP
;	CMP	CX,0DH	; TEMP
;	JB	T1	; TEMP
;	XOR	AX,4	; TEMP
;T1:	; TEMP
	TEST	AL,00000100B
	JZ	@F
	INC	CX
	CMP	CX,10000
	JNE	@B
	CALL	SETREGS
	POP	CX
	POP	DX
	JMP	RET1
@@:	CALL	SETREGS
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
	MOV	AH,AL
	INC	DX
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
	DEC	DX
	AND	AX,0000001111111111B
	PUSH	AX
	MOV	AL,1
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	POP	AX
	POP	DX
	TEST	CX,CX
	JZ	@F
	ADD	BX,AX
	ADC	BP,0
	INC	DX
@@:	POP	CX
	LOOP	GLOCYC
	MOV	CX,DX
	MOV	AX,BX
	MOV	DX,BP
	TEST	CX,CX
	JZ	@F
	DIV	CX
@@:	SHR	CX,1
	CMP	DX,CX
	JB	RET1
	INC	AX
RET1:	POP	BP
	MOV	BX,[BP+0CH]
	MOV	[BX],SI
	MOV	BX,[BP+0AH]
	MOV	[BX],DI
	POP	DI
	POP	SI
	POP	BP
	RET	6
ACPFUN	ENDP
SETREGS	PROC	NEAR
	CMP	CX,SI
	JAE	@F
	MOV	SI,CX
@@:	CMP	CX,DI
	JBE	@F
	MOV	DI,CX
@@:	RET
SETREGS	ENDP
ACPONE	PROC	FAR
	PUSH	BP
	MOV	BP,SP
	MOV	DX,306H
	XOR	AL,AL
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	XOR	CX,CX
@@:	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
;	MOV	AX,3804H	; TEMP
;	CMP	CX,0DH	; TEMP
;	JB	T2	; TEMP
;	XOR	AX,4	; TEMP
;T2:	; TEMP
	TEST	AL,00000100B
	JZ	@F
	INC	CX
	CMP	CX,10000
	JNE	@B
	JMP	RET2
@@:	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
	MOV	AH,AL
	INC	DX
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	IN	AL,DX
	DEC	DX
	AND	AX,0000001111111111B
	PUSH	AX
	MOV	AL,1
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	POP	AX
RET2:	MOV	BX,[BP+6]
	MOV	[BX],CX
	POP	BP
	RET	2
ACPONE	ENDP
ACPRES	PROC	FAR
	MOV	DX,306H
	MOV	AL,1
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	OUT	DX,AL
	JMP	SHORT	$+2
	JMP	SHORT	$+2
	RET
ACPRES	ENDP
ASMEXT_TEXT	ENDS
ASMEXT_DATA	SEGMENT	WORD	PUBLIC	'DATA'
ASMEXT_DATA	ENDS
	END
